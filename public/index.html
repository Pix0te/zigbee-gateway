<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pixote Zigbee Monitor</title>
    <style>
        body { background: #111; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; }
        #log { border: 1px solid #333; padding: 10px; height: 400px; overflow-y: scroll; background: #000; }
        .card { border: 1px solid #0f0; padding: 10px; margin: 10px 0; border-radius: 5px; background: #001a00; }
        h1 { color: #fff; }
        .btn { padding: 10px 20px; background: #333; color: white; border: 1px solid #555; cursor: pointer; }
        .btn:hover { background: #555; }
    </style>
</head>
<body>
    <h1>?? Monitor Zigbee en Vivo</h1>
    <p>Estado: <span id="status" style="color:red">DESCONECTADO</span></p>
    
    <button class="btn" onclick="sendCommand('SCAN')">?? ESCANEAR RED</button>
    <button class="btn" onclick="clearLog()">??? LIMPIAR LOG</button>

    <div id="devices"></div>
    <h3>Consola de Tráfico:</h3>
    <div id="log"></div>

    <script>
        // Detectar si estamos en HTTPS o HTTP para usar wss:// o ws://
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = protocol + window.location.host;
        
        let socket;

        function connect() {
            console.log("Intentando conectar a: " + wsUrl);
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                document.getElementById('status').innerText = "CONECTADO (ONLINE)";
                document.getElementById('status').style.color = "#0f0";
                log("? Sistema conectado al servidor.");
            };

            socket.onmessage = (event) => {
                const raw = event.data;
                log("?? RECIBIDO: " + raw);

                try {
                    const data = JSON.parse(raw);
                    
                    // Si es un nuevo dispositivo, creamos tarjeta
                    if (data.type === 'NEW_DEVICE' || data.type === 'ZIGBEE_MSG') {
                        drawDevice(data.addr);
                    }
                } catch (e) {
                    console.error("No es JSON válido", e);
                }
            };

            socket.onclose = () => {
                document.getElementById('status').innerText = "DESCONECTADO - Reintentando...";
                document.getElementById('status').style.color = "red";
                setTimeout(connect, 2000);
            };
        }

        function sendCommand(cmdType) {
            const msg = JSON.stringify({ cmd: cmdType });
            socket.send(msg);
            log("?? ENVIADO: " + msg);
        }

        function drawDevice(addr) {
            if (document.getElementById('dev-' + addr)) return; // Ya existe
            
            const box = document.createElement('div');
            box.id = 'dev-' + addr;
            box.className = 'card';
            box.innerHTML = `<h3>?? Dispositivo Zigbee</h3><p>Dirección: <b>${addr}</b></p>`;
            document.getElementById('devices').appendChild(box);
            log("? ¡Nueva tarjeta creada para " + addr + "!");
        }

        function log(text) {
            const div = document.getElementById('log');
            const entry = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            entry.innerText = `[${time}] ${text}`;
            div.prepend(entry); // Lo más nuevo arriba
        }
        
        function clearLog() { document.getElementById('log').innerHTML = ''; }

        connect();
    </script>
</body>
</html>
